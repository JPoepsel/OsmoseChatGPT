<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>Osmose Controller</title>

<link rel="stylesheet" href="/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>


<body>

<header class="topBanner">
  <img src="/Banner.png" alt="Osmose Logo" class="bannerImg">

  <div class="versionBox">
    <div id="espVersion">ESP v?</div>
    <div id="spiffVersion">SPIFFS v?</div>
  </div>
</header>

<nav>
  <button type="button" onclick="show('home')">Home</button>
  <button type="button" onclick="show('hist')">History</button>
  <button type="button" onclick="show('set')">Settings</button>

  <div class="navHelp">
    <button type="button"
            onclick="location.href='/Hilfe.html'"
            title="Hilfe">
      üìñ
    </button>
  </div>
</nav>


<!-- ========================================================= -->
<!-- HOME -->
<!-- ========================================================= -->
<section id="home">

<h2 id="state">IDLE</h2>

<div class="grid">
  <div>TDS <b id="tds">0</b></div>
  <div>Liter <b id="liters">0</b></div>
  <div>
    Flow L/min
    <b id="flow">0</b>
    <small id="flowInEff"
           style="display:block;font-size:14px;color:#aaa;">
      IN: 0.00 ¬∑ Eff: 0 %
    </small>
</div>
<div>  Rest
    <b id="left">0</b>
    <small id="timeLeft" style="display:block;font-size:14px;color:#aaa;">0m 0s</small>
  </div>
</div>
<div id="statusLine"
     style="margin-top:10px;
            font-size:14px;
            color:#aaa;
            font-family:monospace;">
  ‚Äì
</div>

<button type="button" id="btnStart" class="start" onclick="startCmd()">Start</button>
<button type="button" id="btnStop"  class="stop"  onclick="stopCmd()">Stop</button>

</section>


<!-- ========================================================= -->
<!-- HISTORY -->
<!-- ========================================================= -->
<section id="hist" hidden>

<h3>üìà History</h3>

<select id="rangeSel">
  <option value="2s">5 Minuten</option>
  <option value="30s">1 Stunde</option>
  <option value="600s">24 Stunden</option>
</select>

<canvas id="chart" height="140"></canvas>

<div id="lastValues" style="margin-top:10px;font-size:14px;"></div>

<div class="histBlock">
  <div class="historyHeader">
    <h2>Production History</h2>
    <button class="dangerBtn" onclick="clearHistory()">Clear</button>
  </div>
  <table id="histTable" border="1" cellspacing="0" cellpadding="4">
    <thead>
      <tr>
        <th>Mode</th>
        <th>Start</th>
        <th>Stop</th>
        <th>Duration</th>
        <th>Liters</th>
        <th>Reason</th>
     </tr>
    </thead>

    <tbody></tbody>
  </table>
</div>

</section>



<!-- ========================================================= -->
<!-- SETTINGS -->
<!-- ========================================================= -->
<section id="set" hidden>

<h3>‚öô Settings</h3>

<div id="settings">

  <h3>Flow Calibration</h3>

  <label class="hint">
    Pulses/Liter IN
    <input id="pulsesPerLiterIn" type="number" step="0.1">
    <span class="hintText">Impulse des Eingangssensors pro Liter f√ºr Durchflussmessung.</span>
  </label>

  <label class="hint">
    Pulses/Liter OUT
    <input id="pulsesPerLiterOut" type="number" step="0.1">
    <span class="hintText">Impulse des Produktsensors pro Liter f√ºr Produktionsberechnung.</span>
  </label>



  <h3>Process</h3>

  <label class="hint">
    TDS Flush Limit
    <input id="tdsLimit" type="number">
    <span class="hintText">Unterhalb dieses TDS-Wertes endet die Sp√ºlung und Produktion startet.</span>
  </label>

  <label class="hint">
    Auto Flush Minimum Time (s)
    <input id="autoFlushMinTimeSec" type="number" step="0.1">
    <span class="hintText">
      Mindestdauer der Vorsp√ºlung, unabh√§ngig vom TDS-Wert.
    </span>
  </label>

  <label class="hint">
    Max. Flush Time (s)
    <input id="maxFlushTimeSec" type="number">
    <span class="hintText">Maximale Sp√ºldauer. Schutz vor endlosem Sp√ºlen.</span>
  </label>

  <label class="hint">
    Max Runtime AUTO (s)
    <input id="maxRuntimeAutoSec" type="number">
    <span class="hintText">Zeitlimit f√ºr den Bezug pro automatischem Durchlauf.</span>
  </label>

  <label class="hint">
    Max Runtime MANUAL (s)
    <input id="maxRuntimeManualSec" type="number">
    <span class="hintText">Zeitlimit f√ºr den Bezug im manuellen Betrieb.</span>
  </label>

  <label class="hint">
    Max Production AUTO (L)
    <input id="maxProductionAutoLiters" type="number" step="0.1">
    <span class="hintText">Maximale Liter pro automatischem Zyklus.</span>
  </label>

  <label class="hint">
    Max Production MANUAL (L)
    <input id="maxProductionManualLiters" type="number" step="0.1">
    <span class="hintText">Maximale Liter im manuellen Betrieb.</span>
  </label>

  <label class="hint">
    Max TDS (ppm) during production
    <input id="tdsMaxAllowed" type="number" step="0.1">
    <span class="hintText">√úberschreitung dieses TDS-Wertes stoppt sofort mit Fehler.</span>
  </label>

  <label class="hint">
    Prepare Time (s)
    <input id="prepareTimeSec" type="number" step="0.1">
    <span class="hintText">Vorlaufzeit vor Sp√ºlen/Produktion (Druckaufbau).</span>
  </label>

  <label class="hint">
    Auto Flush
    <input id="autoFlushEnabled" type="checkbox">
    <span class="hintText">Automatisches Vorsp√ºlen vor jedem Start, bis TDS klein genug.</span>
  </label>

  <label class="hint">
    Post Flush
    <input id="postFlushEnabled" type="checkbox">
    <span class="hintText">Nachsp√ºlen der Osmoseanlage nach Produktionsende erlauben.</span>
  </label>

  <label class="hint">
    Post Flush Time (s)
    <input id="postFlushTimeSec" type="number" step="0.1">
    <span class="hintText">Maximale Dauer f√ºr die Nachsp√ºlung der Osmose-Anlage.</span>
  </label>



  <h3>Service Flush</h3>

  <label class="hint">
    Enable
    <input id="serviceFlushEnabled" type="checkbox">
    <span class="hintText">Regelm√§√üige Sp√ºlung auch ohne Nutzung.</span>
  </label>

  <label class="hint">
    Interval (h)
    <input id="serviceFlushIntervalSec" type="number" step="0.1">
    <span class="hintText">Zeit zwischen Service-Sp√ºlungen in Stunden.</span>
  </label>

  <label class="hint">
    Flush Time (s)
    <input id="serviceFlushTimeSec" type="number">
    <span class="hintText">Komplett-Dauer einer Service-Sp√ºlung inkl. Einschalten und ggf. selbst√§ndiger S√ºlung der Osmose-Anlage.</span>
  </label>



  <h3>System</h3>

  <label class="hint">
    MQTT Host
    <input id="mqttHost">
    <span class="hintText">Adresse des MQTT-Servers (z.B. 192.168.x.x oder myraspi.local, leeres Eingabefeld schaltet MQTT aus).</span>
  </label>

  <label class="hint">
    MQTT Port
    <input id="mqttPort" type="number">
    <span class="hintText">Standard ist 1883.</span>
  </label>

  <label class="hint">
    mDNS Name
    <input id="mDNSName">
    <span class="hintText">Hostname im Netzwerk, z.B. osmose. .local wird automatisch angeh√§ngt!</span>
  </label>



  <label class="wifiRow hint">
    WiFi SSID
    <input id="wifiSSID" autocomplete="off">
    <button type="button" onclick="scanWifi()">Scan</button>
    <span class="hintText">WLAN-Netzwerk, mit dem sich das Ger√§t verbindet.</span>
  </label>

  <div id="wifiResults" class="wifiResults" hidden></div>



  <label class="hint">
    WiFi Password
    <div class="pwWrap">
      <input id="wifiPassword" type="password">
      <span class="pwEye" onclick="togglePw('wifiPassword')">üëÅ</span>
    </div>
    <span class="hintText">Passwort f√ºr das WLAN.</span>
  </label>

  <label class="hint">
    AP Password
    <div class="pwWrap">
      <input id="APPassWord" type="password">
      <span class="pwEye" onclick="togglePw('APPassWord')">üëÅ</span>
    </div>
    <span class="hintText">Passwort des Notfall-Access-Points. Mindestens 8 Zeichen oder leer f√ºr ungesch√ºtzt.</span>
  </label>



  <br><br>

  <div class="settingsButtons">
    <div>
      <button type="button" onclick="saveSettings()">Save</button>
      <button type="button" onclick="saveAndReboot()">Save & Reboot</button>
    </div>

    <button type="button" class="save" onclick="location.href='/update'">
      Firmware update‚Ä¶
    </button>
  </div>

</div>

</section>



<script src="/app.js"></script>

</body>
</html>
